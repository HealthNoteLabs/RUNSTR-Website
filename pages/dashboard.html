<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RUNSTR</title>

    <!-- Nostr Login -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nostr-login@latest/dist/unpkg.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/nostr-login@latest/dist/unpkg.js"></script>

    <!-- Nostr Tools for Nostr operations -->
    <script src="https://unpkg.com/nostr-tools@2.7.2/lib/nostr.bundle.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #0a0a0a;
            --dark-gray: #1a1a1a;
            --medium-gray: #2a2a2a;
            --light-gray: #888;
            --white: #ffffff;
            --accent: #f0f0f0;
            --orange: #F5A356;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--black);
            color: var(--white);
            line-height: 1.6;
        }

        /* Navigation Header */
        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--medium-gray);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--white);
            text-decoration: none;
            letter-spacing: -1px;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 6rem auto 2rem;
            padding: 2rem;
        }

        .login-section {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--dark-gray);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .login-section h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .login-section p {
            color: var(--light-gray);
            margin-bottom: 2rem;
        }

        .fitness-level-section {
            width: 100%;
            margin-bottom: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        /* Level System Styles */
        .level-ring-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem 0.5rem;
        }

        .level-ring-svg {
            margin-bottom: 0.75rem;
        }

        .level-center-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .level-number {
            font-size: 1.25rem;
            font-weight: 900;
            color: #FFB366;
            line-height: 1;
        }

        .level-label {
            font-size: 0.5rem;
            font-weight: 700;
            color: #FF9D42;
            letter-spacing: 1px;
            margin-top: 0.15rem;
        }

        .level-stats-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-top: 0.5rem;
        }

        .level-stat-item {
            text-align: center;
            flex: 1;
        }

        .level-stat-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: #FFB366;
            margin-bottom: 0.15rem;
        }

        .level-stat-label {
            font-size: 0.6rem;
            font-weight: 500;
            color: #CC7A33;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .level-stat-divider {
            width: 1px;
            height: 20px;
            background: var(--medium-gray);
        }

        .level-milestone {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--medium-gray);
            text-align: center;
        }

        .level-milestone-text {
            font-size: 0.65rem;
            font-weight: 500;
            color: #FF9D42;
        }

        /* Monthly Grouping Styles */
        .month-group {
            margin-bottom: 1.5rem;
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--medium-gray);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .month-header:hover {
            background: #333;
        }

        .month-title {
            font-weight: 700;
            color: var(--white);
            font-size: 1.1rem;
        }

        .month-count {
            color: var(--orange);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .month-workouts {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-left: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .month-workouts.expanded {
            max-height: 5000px;
            padding: 0.5rem 0;
        }

        .dashboard-section {
            background: var(--dark-gray);
            border: 1px solid var(--medium-gray);
            padding: 2rem;
            border-radius: 8px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 900;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--orange);
            color: var(--black);
            text-decoration: none;
            font-weight: 700;
            transition: all 0.3s;
            border: 2px solid var(--orange);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn:hover {
            background: transparent;
            color: var(--orange);
        }

        .btn-secondary {
            background: transparent;
            color: var(--light-gray);
            border-color: var(--medium-gray);
        }

        .btn-secondary:hover {
            color: var(--white);
            border-color: var(--light-gray);
        }

        /* Workout Feed */
        .workout-feed {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .workout-card {
            background: var(--medium-gray);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--dark-gray);
            transition: all 0.3s;
        }

        .workout-card:hover {
            border-color: var(--orange);
            transform: translateX(5px);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .workout-type {
            font-weight: 700;
            color: var(--orange);
            text-transform: capitalize;
        }

        .workout-date {
            color: var(--light-gray);
            font-size: 0.9rem;
        }

        .workout-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .workout-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }

        .stat-label {
            color: var(--light-gray);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        /* Team List */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .team-card {
            background: var(--medium-gray);
            border-radius: 8px;
            border: 1px solid var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }

        .team-card:hover {
            border-color: var(--orange);
            transform: scale(1.02);
        }

        .team-banner {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            background-size: cover;
            background-position: center;
        }

        .team-content {
            padding: 1.5rem;
        }

        .team-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .team-name {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .charity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .charity-opensats {
            background: rgba(245, 163, 86, 0.2);
            color: var(--orange);
        }

        .charity-hrf {
            background: rgba(100, 150, 255, 0.2);
            color: #6496ff;
        }

        .team-meta {
            color: var(--light-gray);
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--light-gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--light-gray);
        }

        .spinner {
            border: 3px solid var(--medium-gray);
            border-top: 3px solid var(--orange);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .workout-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-content {
                padding: 1rem;
            }

            .nav-header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="nav-header">
        <a href="../index.html" class="nav-logo">RUNSTR</a>
        <div class="nav-actions">
            <nostr-login></nostr-login>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Login Section (shown when not logged in) -->
        <div id="login-section" class="login-section">
            <h2>Welcome to RUNSTR Dashboard</h2>
            <p>Login with your Nostr account to view your workouts and manage your teams</p>
            <div class="empty-state-icon">🏃</div>
        </div>

        <!-- Dashboard Content (shown when logged in) -->
        <div id="dashboard-content" style="display: none;">
            <!-- Fitness Level Section (Full Width at Top) -->
            <div class="dashboard-section fitness-level-section">
                <div class="section-header">
                    <h2 class="section-title">Your Nostr Fitness Level</h2>
                </div>

                <div id="level-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading level...</p>
                </div>

                <div id="level-display" class="level-ring-container" style="display: none;"></div>
            </div>

            <!-- Two Column Layout: Workouts (Left) + Teams (Right) -->
            <div class="dashboard-grid">
                <!-- Workout Feed -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">Your Workouts</h2>
                    </div>

                    <div id="workout-loading" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">Loading your workouts...</p>
                    </div>

                    <div id="workout-feed" class="workout-feed" style="display: none;"></div>

                    <div id="workout-empty" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">📝</div>
                        <p>No workouts found</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Start tracking your fitness with the RUNSTR mobile app</p>
                    </div>
                </div>

                <!-- Teams Section -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">Your Teams</h2>
                        <button class="btn" onclick="createTeam()">Create Team</button>
                    </div>

                    <div id="team-loading" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">Loading teams...</p>
                    </div>

                    <div id="team-list" class="team-list" style="display: none;"></div>

                    <div id="team-empty" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">👥</div>
                        <p>No teams yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Create your first team to start competing</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let pool;
        let currentUser = null;
        const RELAYS = ['wss://relay.damus.io', 'wss://nos.lol', 'wss://relay.nostr.band'];

        // Session persistence constants
        const SESSION_KEY = 'runstr_nostr_session';
        const SESSION_MAX_AGE = 30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds

        // Session management functions
        function saveSession(userData) {
            try {
                const session = {
                    pubkey: userData.pubkey,
                    npub: userData.npub,
                    loginTimestamp: Date.now()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                console.log('💾 Session saved to localStorage');
            } catch (error) {
                console.error('❌ Failed to save session:', error);
            }
        }

        function loadSession() {
            try {
                const sessionData = localStorage.getItem(SESSION_KEY);
                if (!sessionData) {
                    console.log('ℹ️ No saved session found');
                    return null;
                }

                const session = JSON.parse(sessionData);

                // Validate session age
                const sessionAge = Date.now() - session.loginTimestamp;
                if (sessionAge > SESSION_MAX_AGE) {
                    console.log('⏰ Session expired, clearing...');
                    clearSession();
                    return null;
                }

                console.log('✅ Valid session found in localStorage');
                return session;
            } catch (error) {
                console.error('❌ Failed to load session:', error);
                clearSession();
                return null;
            }
        }

        function clearSession() {
            try {
                localStorage.removeItem(SESSION_KEY);
                console.log('🗑️ Session cleared from localStorage');
            } catch (error) {
                console.error('❌ Failed to clear session:', error);
            }
        }

        function restoreSessionUI(session) {
            currentUser = session;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            console.log('🔄 Session UI restored');
        }

        // Level System Constants (from RUNSTR mobile app)
        const XP_CONSTANTS = {
            BASE_PER_WORKOUT: 10,
            PER_KM: 1,
            PER_10_MINUTES: 1,
            PER_100_CALORIES: 5,
            XP_PER_LEVEL: 100
        };

        const LEVEL_MILESTONES = [
            { level: 1, title: 'Beginner', description: 'Just getting started' },
            { level: 5, title: 'Rookie', description: '5 levels completed' },
            { level: 10, title: 'Athlete', description: '10 levels completed' },
            { level: 20, title: 'Veteran', description: '20 levels completed' },
            { level: 30, title: 'Champion', description: '30 levels completed' },
            { level: 50, title: 'Legend', description: '50 levels completed' },
            { level: 75, title: 'Master', description: '75 levels completed' },
            { level: 100, title: 'Elite', description: '100 levels completed' }
        ];

        // Calculate XP from a single workout
        function calculateWorkoutXP(workout) {
            const baseXP = XP_CONSTANTS.BASE_PER_WORKOUT;

            // Distance bonus: +1 XP per km
            const distanceTag = workout.tags.find(t => t[0] === 'distance');
            const distanceKm = distanceTag ? parseFloat(distanceTag[1]) : 0;
            const distanceBonus = Math.floor(distanceKm * XP_CONSTANTS.PER_KM);

            // Duration bonus: +1 XP per 10 minutes
            const durationTag = workout.tags.find(t => t[0] === 'duration');
            const durationSeconds = durationTag ? parseDuration(durationTag[1]) : 0;
            const durationMinutes = durationSeconds / 60;
            const durationBonus = Math.floor(durationMinutes / 10) * XP_CONSTANTS.PER_10_MINUTES;

            // Calorie bonus: +5 XP per 100 calories
            let calories = 0;
            try {
                if (workout.content) {
                    const match = workout.content.match(/(\d+)\s*calories/i);
                    if (match) calories = parseInt(match[1]);
                }
            } catch (e) {}
            const calorieBonus = Math.floor(calories / 100) * XP_CONSTANTS.PER_100_CALORIES;

            return baseXP + distanceBonus + durationBonus + calorieBonus;
        }

        // Parse duration string (HH:MM:SS or seconds)
        function parseDuration(duration) {
            if (!duration) return 0;
            if (typeof duration === 'number') return duration;

            // Check if it's in HH:MM:SS format
            if (duration.includes(':')) {
                const parts = duration.split(':').map(p => parseInt(p) || 0);
                if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2];
                } else if (parts.length === 2) {
                    return parts[0] * 60 + parts[1];
                }
            }
            return parseInt(duration) || 0;
        }

        // Calculate level from total XP
        function calculateLevel(totalXP) {
            const level = Math.floor(totalXP / XP_CONSTANTS.XP_PER_LEVEL);
            const currentXP = totalXP % XP_CONSTANTS.XP_PER_LEVEL;
            const xpForNextLevel = XP_CONSTANTS.XP_PER_LEVEL;
            const progress = currentXP / xpForNextLevel;

            return { level, currentXP, xpForNextLevel, totalXP, progress };
        }

        // Get next milestone
        function getNextMilestone(currentLevel) {
            return LEVEL_MILESTONES.find(m => currentLevel < m.level) || null;
        }

        // Group workouts by month
        function groupWorkoutsByMonth(workouts) {
            const groups = {};

            workouts.forEach(workout => {
                const startTag = workout.tags.find(t => t[0] === 'start');
                const date = startTag ? new Date(startTag[1]) : new Date(workout.created_at * 1000);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                if (!groups[monthKey]) {
                    groups[monthKey] = {
                        label: monthLabel,
                        workouts: [],
                        date: date
                    };
                }
                groups[monthKey].workouts.push(workout);
            });

            // Sort by date (most recent first)
            return Object.values(groups).sort((a, b) => b.date - a.date);
        }

        // Render circular progress ring with level
        function renderLevelRing(levelData, totalWorkouts) {
            const size = 60;
            const strokeWidth = 4;
            const center = size / 2;
            const radius = (size - strokeWidth) / 2;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference * (1 - levelData.progress);

            const nextMilestone = getNextMilestone(levelData.level);

            return `
                <div style="position: relative; width: ${size}px; height: ${size}px;">
                    <svg class="level-ring-svg" width="${size}" height="${size}">
                        <defs>
                            <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FF7B1C;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FF9D42;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <!-- Background circle -->
                        <circle
                            cx="${center}"
                            cy="${center}"
                            r="${radius}"
                            stroke="#1a1a1a"
                            stroke-width="${strokeWidth}"
                            fill="none"
                        />

                        <!-- Progress circle -->
                        <circle
                            cx="${center}"
                            cy="${center}"
                            r="${radius}"
                            stroke="url(#ringGradient)"
                            stroke-width="${strokeWidth}"
                            fill="none"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${strokeDashoffset}"
                            stroke-linecap="round"
                            transform="rotate(-90 ${center} ${center})"
                        />
                    </svg>

                    <div class="level-center-content">
                        <div class="level-number">${levelData.level}</div>
                        <div class="level-label">LEVEL</div>
                    </div>
                </div>

                <div class="level-stats-row">
                    <div class="level-stat-item">
                        <div class="level-stat-value">${totalWorkouts}</div>
                        <div class="level-stat-label">Workouts</div>
                    </div>
                    <div class="level-stat-divider"></div>
                    <div class="level-stat-item">
                        <div class="level-stat-value">${levelData.currentXP} / ${levelData.xpForNextLevel} XP</div>
                        <div class="level-stat-label">Progress</div>
                    </div>
                </div>

                ${nextMilestone ? `
                    <div class="level-milestone">
                        <div class="level-milestone-text">
                            Next: ${nextMilestone.title} at Level ${nextMilestone.level}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Toggle month expansion
        function toggleMonth(monthKey) {
            const monthWorkouts = document.getElementById(`month-${monthKey}`);
            if (monthWorkouts) {
                monthWorkouts.classList.toggle('expanded');
            }
        }

        // Initialize nostr-tools SimplePool
        function initializeNostr() {
            try {
                pool = new NostrTools.SimplePool();
                console.log('✅ Nostr pool initialized');
                return pool;
            } catch (error) {
                console.error('❌ Failed to initialize Nostr pool:', error);
                throw error;
            }
        }

        // Listen for nostr-login events
        document.addEventListener('nlAuth', async (e) => {
            console.log('🔐 User logged in:', e.detail);
            currentUser = e.detail;

            // Save session to localStorage
            saveSession(currentUser);

            // Hide login section, show dashboard
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';

            // Initialize Nostr pool if not already done
            if (!pool) {
                initializeNostr();
            }

            // Load user data
            await Promise.all([
                loadUserWorkouts(currentUser.pubkey),
                loadUserTeams(currentUser.pubkey)
            ]);
        });

        document.addEventListener('nlLogout', () => {
            console.log('👋 User logged out');
            currentUser = null;

            // Clear session from localStorage
            clearSession();

            // Show login section, hide dashboard
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';

            // Clear data
            document.getElementById('workout-feed').innerHTML = '';
            document.getElementById('team-list').innerHTML = '';
        });

        // Load user's 1301 workout events
        async function loadUserWorkouts(pubkey) {
            const workoutLoading = document.getElementById('workout-loading');
            const workoutFeed = document.getElementById('workout-feed');
            const workoutEmpty = document.getElementById('workout-empty');
            const levelLoading = document.getElementById('level-loading');
            const levelDisplay = document.getElementById('level-display');

            try {
                workoutLoading.style.display = 'block';
                workoutFeed.style.display = 'none';
                workoutEmpty.style.display = 'none';
                levelLoading.style.display = 'block';
                levelDisplay.style.display = 'none';

                console.log('📊 Loading workouts for:', pubkey);

                const filter = {
                    kinds: [1301],
                    authors: [pubkey]
                };

                // Use SimplePool to query events
                const events = await pool.querySync(RELAYS, filter);
                const workouts = events || [];

                console.log(`✅ Found ${workouts.length} workouts`);

                workoutLoading.style.display = 'none';
                levelLoading.style.display = 'none';

                if (workouts.length === 0) {
                    workoutEmpty.style.display = 'block';
                    return;
                }

                // Calculate total XP and level from all workouts
                let totalXP = 0;
                workouts.forEach(workout => {
                    totalXP += calculateWorkoutXP(workout);
                });
                const levelData = calculateLevel(totalXP);

                console.log(`🎮 Level ${levelData.level} - ${levelData.currentXP}/${levelData.xpForNextLevel} XP`);

                // Display level ring
                levelDisplay.style.display = 'flex';
                levelDisplay.innerHTML = renderLevelRing(levelData, workouts.length);

                // Group workouts by month
                const monthGroups = groupWorkoutsByMonth(workouts.sort((a, b) => b.created_at - a.created_at));
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format

                // Render monthly grouped workouts
                workoutFeed.style.display = 'flex';
                workoutFeed.innerHTML = monthGroups.map((group, index) => {
                    const monthKey = `${group.date.getFullYear()}-${String(group.date.getMonth() + 1).padStart(2, '0')}`;
                    const isCurrentMonth = monthKey === currentMonth;

                    return `
                        <div class="month-group">
                            <div class="month-header" onclick="toggleMonth('${monthKey}')">
                                <div class="month-title">${group.label}</div>
                                <div class="month-count">${group.workouts.length} workout${group.workouts.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div id="month-${monthKey}" class="month-workouts ${isCurrentMonth ? 'expanded' : ''}">
                                ${group.workouts.map(workout => renderWorkoutCard(workout)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('❌ Failed to load workouts:', error);
                workoutLoading.style.display = 'none';
                levelLoading.style.display = 'none';
                workoutEmpty.style.display = 'block';
            }
        }

        // Render a workout card
        function renderWorkoutCard(workout) {
            const typeTag = workout.tags.find(t => t[0] === 'type');
            const type = typeTag ? typeTag[1] : 'Workout';

            const distanceTag = workout.tags.find(t => t[0] === 'distance');
            const distance = distanceTag ? `${distanceTag[1]} ${distanceTag[2] || 'km'}` : 'N/A';

            const durationTag = workout.tags.find(t => t[0] === 'duration');
            const duration = durationTag ? durationTag[1] : 'N/A';

            const startTag = workout.tags.find(t => t[0] === 'start');
            const date = startTag ? new Date(startTag[1]).toLocaleDateString() : new Date(workout.created_at * 1000).toLocaleDateString();

            // Try to parse calories from content
            let calories = 'N/A';
            try {
                if (workout.content) {
                    const match = workout.content.match(/(\d+)\s*calories/i);
                    if (match) calories = match[1];
                }
            } catch (e) {}

            return `
                <div class="workout-card">
                    <div class="workout-header">
                        <span class="workout-type">${type}</span>
                        <span class="workout-date">${date}</span>
                    </div>
                    <div class="workout-stats">
                        <div class="workout-stat">
                            <div class="stat-value">${distance}</div>
                            <div class="stat-label">Distance</div>
                        </div>
                        <div class="workout-stat">
                            <div class="stat-value">${duration}</div>
                            <div class="stat-label">Duration</div>
                        </div>
                        <div class="workout-stat">
                            <div class="stat-value">${calories}</div>
                            <div class="stat-label">Calories</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load user's teams (33404 events where user is captain or member)
        async function loadUserTeams(pubkey) {
            const teamLoading = document.getElementById('team-loading');
            const teamList = document.getElementById('team-list');
            const teamEmpty = document.getElementById('team-empty');

            try {
                teamLoading.style.display = 'block';
                teamList.style.display = 'none';
                teamEmpty.style.display = 'none';

                console.log('👥 Loading teams for:', pubkey);

                // Query teams where user is the captain
                const filter = {
                    kinds: [33404],
                    authors: [pubkey],
                    limit: 50
                };

                // Use SimplePool to query events
                const events = await pool.querySync(RELAYS, filter);
                const teams = events || [];

                console.log(`✅ Found ${teams.length} teams`);

                teamLoading.style.display = 'none';

                if (teams.length === 0) {
                    teamEmpty.style.display = 'block';
                    return;
                }

                teamList.style.display = 'flex';
                teamList.innerHTML = teams
                    .map(team => renderTeamCard(team))
                    .join('');

            } catch (error) {
                console.error('❌ Failed to load teams:', error);
                teamLoading.style.display = 'none';
                teamEmpty.style.display = 'block';
            }
        }

        // Render a team card
        function renderTeamCard(team) {
            const nameTag = team.tags.find(t => t[0] === 'name');
            const name = nameTag ? nameTag[1] : 'Unnamed Team';

            const dTag = team.tags.find(t => t[0] === 'd');
            const teamId = dTag ? dTag[1] : team.id;

            // Extract banner image
            const bannerTag = team.tags.find(t => t[0] === 'banner' || t[0] === 'image');
            const bannerUrl = bannerTag ? bannerTag[1] : null;

            // Extract charity
            const charityTag = team.tags.find(t => t[0] === 'charity');
            const charityId = charityTag ? charityTag[1] : null;

            // Map charity IDs to display information
            const charityInfo = {
                'opensats': { name: 'OpenSats', icon: '⚡', class: 'charity-opensats' },
                'hrf': { name: 'HRF', icon: '🗽', class: 'charity-hrf' }
            };
            const charity = charityId ? charityInfo[charityId] : null;

            const description = team.content || 'No description';
            const truncatedDesc = description.length > 100 ? description.substring(0, 100) + '...' : description;

            const bannerStyle = bannerUrl ? `background-image: url('${bannerUrl}');` : '';

            return `
                <div class="team-card" onclick="navigateToTeam('${teamId}', '${team.pubkey}')">
                    <div class="team-banner" style="${bannerStyle}"></div>
                    <div class="team-content">
                        <div class="team-header-row">
                            <div class="team-name">${name}</div>
                            ${charity ? `<span class="charity-badge ${charity.class}">${charity.icon} ${charity.name}</span>` : ''}
                        </div>
                        <div class="team-meta">${truncatedDesc}</div>
                    </div>
                </div>
            `;
        }

        // Navigate to team management page
        window.navigateToTeam = function(teamId, captainPubkey) {
            window.location.href = `team-management.html?teamId=${encodeURIComponent(teamId)}&captain=${encodeURIComponent(captainPubkey)}`;
        }

        // Create team function
        window.createTeam = function() {
            alert('Team creation wizard coming soon! This will allow you to create a new team with charity selection, banner image, and member management.');
            // TODO: Implement team creation modal/wizard
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initializeNostr();

            // Check for existing session in localStorage
            const savedSession = loadSession();

            if (savedSession) {
                console.log('🔍 Found saved session, waiting for nostr-login to restore...');

                // Set a timeout to check if nlAuth fired
                let authFired = false;
                const originalNlAuth = document.addEventListener;

                // Track if nlAuth event fires
                const checkAuthEvent = (e) => {
                    if (e.type === 'nlAuth') {
                        authFired = true;
                    }
                };
                document.addEventListener('nlAuth', checkAuthEvent);

                // Fallback: If nlAuth doesn't fire within 2 seconds, manually restore
                setTimeout(async () => {
                    if (!authFired && !currentUser) {
                        console.log('⚠️ nostr-login did not auto-restore session, using fallback...');
                        restoreSessionUI(savedSession);

                        // Load user data manually
                        await Promise.all([
                            loadUserWorkouts(savedSession.pubkey),
                            loadUserTeams(savedSession.pubkey)
                        ]);
                    } else if (authFired) {
                        console.log('✅ nostr-login successfully auto-restored session');
                    }
                }, 2000);
            } else {
                console.log('ℹ️ No saved session, waiting for user to login...');
            }
        });
    </script>
</body>
</html>
